import{r as m,L as ke,M as Pe,b as Re,H as Ce,a as Ee,R as J,D as be,I as _e,y as Ae,T as Se,o as ie,s as De,p as Oe,c as Te,d as Be,P as Fe,e as Me,f as fe,g as ze,j as e,u as Q,h as re,i as q,k as X,l as _,m as I,n as Ie,q as $e,E as d,t as je,B as K,v as $,w as W,x as L,z as Ue,A as D,C as G,F as le,G as ae,S as ve,J as de,K as A,N as Ve,O as ee,Q as se,U as oe,V as ce,W as me,X as ge,Y as te,Z as p,_ as We,$ as He,a0 as Le,a1 as Ge,a2 as Qe,a3 as pe,a4 as qe,a5 as ye,a6 as Ke,a7 as Ye,a8 as Ze}from"./index-df610617.js";let he=m.createContext(null);he.displayName="GroupContext";let Je=m.Fragment;function Xe(s){var n;let[t,a]=m.useState(null),[r,i]=Ce(),[y,c]=Ee(),P=m.useMemo(()=>({switch:t,setSwitch:a,labelledby:r,describedby:y}),[t,a,r,y]),u={},j=s;return J.createElement(c,{name:"Switch.Description"},J.createElement(i,{name:"Switch.Label",props:{htmlFor:(n=P.switch)==null?void 0:n.id,onClick(x){t&&(x.currentTarget.tagName==="LABEL"&&x.preventDefault(),t.click(),t.focus({preventScroll:!0}))}}},J.createElement(he.Provider,{value:P},be({ourProps:u,theirProps:j,defaultTag:Je,name:"Switch.Group"}))))}let es="button";function ss(s,n){let t=_e(),{id:a=`headlessui-switch-${t}`,checked:r,defaultChecked:i=!1,onChange:y,name:c,value:P,...u}=s,j=m.useContext(he),x=m.useRef(null),N=Ae(x,n,j===null?null:j.setSwitch),[b,h]=Se(r,y,i),o=ie(()=>h==null?void 0:h(!b)),R=ie(v=>{if(Me(v.currentTarget))return v.preventDefault();v.preventDefault(),o()}),g=ie(v=>{v.key===fe.Space?(v.preventDefault(),o()):v.key===fe.Enter&&ze(v.currentTarget)}),w=ie(v=>v.preventDefault()),B=m.useMemo(()=>({checked:b}),[b]),M={id:a,ref:N,role:"switch",type:De(s,x),tabIndex:0,"aria-checked":b,"aria-labelledby":j==null?void 0:j.labelledby,"aria-describedby":j==null?void 0:j.describedby,onClick:R,onKeyUp:g,onKeyPress:w},O=Oe();return m.useEffect(()=>{var v;let U=(v=x.current)==null?void 0:v.closest("form");U&&i!==void 0&&O.addEventListener(U,"reset",()=>{h(i)})},[x,h]),J.createElement(J.Fragment,null,c!=null&&b&&J.createElement(Te,{features:Be.Hidden,...Fe({as:"input",type:"checkbox",hidden:!0,readOnly:!0,checked:b,name:c,value:P})}),be({ourProps:M,theirProps:u,slot:B,defaultTag:es,name:"Switch"}))}let ns=ke(ss),ls=Xe,as=Object.assign(ns,{Group:ls,Label:Pe,Description:Re});function Ne({report:s}){return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",s.total]}),e.jsxs("p",{children:["Succeeded: ",s.successful]}),e.jsxs("p",{children:["Failed: ",s.failures]}),e.jsxs("p",{children:["Errors: ",s.errors]}),e.jsxs("p",{children:["Dialect: ",s.dialect]})]}),e.jsx("ul",{children:s.details.map(n=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"â€”"}),e.jsxs("div",{className:"mr-4",children:[e.jsx("span",{className:"inline-block mb-2",children:n.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:n.details})})]})]},n.message))})]})}function ts({setRefTasksOverview:s}){const{backfills:n,hasChanges:t,hasBackfills:a,activeBackfill:r,modified:i,added:y,removed:c,virtualUpdateDescription:P,skip_backfill:u,skip_tests:j,change_categorization:x,hasVirtualUpdate:N,testsReportErrors:b,testsReportMessages:h}=Q(),o=re(f=>f.environment),R=q(f=>f.state),g=q(f=>f.action),w=m.useMemo(()=>Array.from(x.values()).reduce((f,{category:C,change:k})=>{var T;return(T=k==null?void 0:k.indirect)==null||T.forEach(E=>{var z;f[E]==null&&(f[E]=[]),(z=f[E])==null||z.push(C.value!==1)}),C.value===3&&(f[k.model_name]=[!0]),f},{}),[x]),B=m.useCallback(f=>Object.entries(f).reduce((C,[k,T])=>{const E=w[k];return(E!=null?E.every(Boolean):!1)||(C[k]=T),C},{}),[w]),M=m.useCallback(f=>f.reduce((C,k)=>{const T=k.model_name,E=k.interval,z={completed:0,total:k.batches,interval:E,view_name:k.view_name},Y=w[T];return(Y!=null?Y.every(Boolean):!1)||(C[T]=z),C},{}),[w]),O=m.useMemo(()=>(r==null?void 0:r.tasks)!=null?B(r.tasks):M(n),[n,x,r]),v=R===A.Finished,U=[t,a,X(O)].every(_),H=N&&_(v)||_(U)&&a&&_(u)&&I(Object.keys(O)),V=Ie({planAction:g,planState:R,hasBackfills:a,hasVirtualUpdate:N,hasNoChanges:U||$e(Object.keys(O)),skip_backfill:u});return e.jsx("div",{className:"w-full overflow-hidden overflow-y-auto p-4 scrollbar scrollbar--vertical",children:e.jsx("ul",{className:"w-full",children:g===d.Run?e.jsx(F.StepOptions,{className:"w-full"}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{headline:"Tests",description:"Report",disabled:o==null,children:g===d.Running?e.jsx(ne,{hasSpinner:!0,children:"Running Tests ..."}):je(b)&&je(h)?e.jsx(ne,{children:j?"Tests Skipped":"No Tests"}):e.jsxs(e.Fragment,{children:[b!=null&&e.jsx(K,{variant:$.Danger,children:X(b)&&e.jsx(Ne,{report:b})}),h!=null&&e.jsx(K,{variant:$.Success,children:X(h)&&e.jsx("div",{children:h.message})})]})}),e.jsx(ue,{headline:"Models",description:"Review Changes",disabled:o==null,children:t?e.jsxs(e.Fragment,{children:[(I(y)||I(c))&&e.jsxs("div",{className:"flex",children:[I(y)&&e.jsx(W,{className:"w-full m-2",headline:"Added Models",type:L.Add,children:e.jsx(W.Default,{type:L.Add,changes:y})}),I(c)&&e.jsx(W,{className:"w-full m-2",headline:"Removed Models",type:L.Remove,children:e.jsx(W.Default,{type:L.Remove,changes:c})})]}),Ue(i)&&e.jsxs(e.Fragment,{children:[I(i==null?void 0:i.direct)&&e.jsx(W,{className:"m-2",headline:"Modified Directly",type:L.Direct,children:e.jsx(W.Direct,{changes:i.direct??[]})}),I(i.indirect)&&e.jsx(W,{className:"m-2",headline:"Modified Indirectly",type:L.Indirect,children:e.jsx(W.Indirect,{changes:i.indirect??[]})}),I(i==null?void 0:i.metadata)&&e.jsx(W,{className:"m-2",headline:"Modified Metadata",type:L.Metadata,children:e.jsx(W.Default,{type:L.Metadata,changes:(i==null?void 0:i.metadata)??[]})})]})]}):g===d.Running?e.jsx(ne,{hasSpinner:!0,children:"Checking Models..."}):e.jsx(ne,{children:"No Changes"})}),e.jsx(ue,{headline:"Backfill",description:"Progress",disabled:o==null,children:e.jsx(D,{defaultOpen:a,children:({open:f})=>e.jsxs(e.Fragment,{children:[e.jsx(ne,{hasSpinner:_(f)&&(g===d.Running||g===d.Applying),children:e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("h3",{className:G(R===A.Cancelled&&"text-prose",R===A.Failed&&"text-danger-700",R===A.Finished&&"text-success-700"),children:V})}),H&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"mr-2 text-sm",children:"Details"}),e.jsx(D.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:f?e.jsx(le,{className:"h-6 w-6 text-primary-500"}):e.jsx(ae,{className:"h-6 w-6 text-primary-500"})})]})]})}),e.jsxs(D.Panel,{className:"px-4 pb-2 text-sm",children:[a&&_(u)&&I(Object.keys(O))&&e.jsx(e.Fragment,{children:e.jsx(m.Suspense,{fallback:e.jsx(ve,{className:"w-4 h-4 mr-2"}),children:e.jsx(de,{tasks:O,setRefTasksOverview:s,children:({total:C,completed:k,models:T,completedBatches:E,totalBatches:z})=>e.jsxs(e.Fragment,{children:[e.jsx(de.Summary,{environment:o.name,planState:R,headline:"Target Environment",completed:k,total:C,completedBatches:E,totalBatches:z,updateType:N?"Virtual":"Backfill",updatedAt:r==null?void 0:r.updated_at}),T!=null&&e.jsx(de.Details,{models:T,changes:{modified:i,added:y,removed:c},showBatches:a,showVirtualUpdate:N,showProgress:!0})]})})})}),N&&e.jsx("div",{children:e.jsx("small",{className:"text-sm",children:P})})]})]})},V)})]})})})}function ne({hasSpinner:s=!1,children:n}){return e.jsx("span",{className:"mt-1 mb-4 px-4 py-2 bg-primary-10 flex w-full rounded-lg",children:e.jsxs("span",{className:"flex items-center w-full",children:[s&&e.jsx(ve,{className:"w-4 h-4 mr-2"}),n]})})}function ue({headline:s,description:n,children:t,disabled:a=!1}){return e.jsxs("li",{className:"mb-2 p-4",children:[e.jsx(rs,{className:"min-w-[25%] pr-12",headline:s,disabled:a,children:n}),!a&&t]})}function rs({disabled:s=!1,headline:n,children:t,className:a}){return e.jsxs("div",{className:G(s&&"opacity-40 cursor-not-allowed","mb-4 ",a),children:[n!=null&&e.jsx("h3",{className:"whitespace-nowrap font-bold text-lg",children:n}),t!=null&&e.jsx("small",{className:"whitespace-nowrap",children:t})]})}function is(){const s=re(a=>a.environment),{errors:n,testsReportErrors:t}=Q();return e.jsxs("div",{className:"flex flex-col py-2 w-full",children:[e.jsxs("h4",{className:"text-xl pb-2 px-6",children:[e.jsx("span",{className:"font-bold",children:"Target Environment is"}),e.jsx("b",{className:"ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:s.name})]}),e.jsxs("div",{className:"w-full h-full overflow-auto scrollbar scrollbar--vertical px-6 ",children:[s.isInitial&&s.isDefault&&e.jsx(K,{variant:$.Warning,children:e.jsx(D,{defaultOpen:!0,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(K.Headline,{className:"w-full mr-2 text-sm",children:"Initializing Prod Environment"}),e.jsx(D.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(le,{className:"h-6 w-6 text-warning-500"}):e.jsx(ae,{className:"h-6 w-6 text-warning-500"})})]}),e.jsx(D.Panel,{className:"px-4 pb-2 text-sm",children:e.jsx(K.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})}),I(n)&&e.jsx(K,{variant:$.Danger,children:e.jsx(D,{defaultOpen:!0,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("p",{className:"w-full mr-2 text-sm",children:[n.length," ",Ve("Error",n.length)]}),e.jsx(D.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(le,{className:"h-6 w-6 text-danger-500"}):e.jsx(ae,{className:"h-6 w-6 text-danger-500"})})]}),e.jsx(D.Panel,{className:"px-4 pb-2 text-sm",children:e.jsx("ul",{className:"mt-2",children:n.map(r=>e.jsxs("li",{children:[e.jsx("span",{className:"inline-block mr-2",children:"â€”"}),e.jsx("span",{children:r})]},r))})})]})})}),t!=null&&X(t)&&e.jsx(K,{variant:$.Danger,children:e.jsx(D,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"w-full mr-2 text-sm",children:t==null?void 0:t.title}),e.jsx(D.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(le,{className:"h-6 w-6 text-danger-500"}):e.jsx(ae,{className:"h-6 w-6 text-danger-500"})})]}),e.jsx(D.Panel,{className:"px-4 pb-2 text-sm",children:e.jsx(Ne,{report:t})})]})})})]})]})}function cs(s=0){return m.useCallback(n=>{setTimeout(()=>{n==null||n.focus()},s)},[s])}function os({planAction:s,disabled:n,run:t,apply:a,cancel:r,close:i,reset:y}){const{start:c,end:P,hasBackfills:u,skip_tests:j,auto_apply:x,skip_backfill:N,no_gaps:b,no_auto_categorization:h,forward_only:o,restate_models:R,hasVirtualUpdate:g}=Q(),w=re(S=>S.environment),B=cs(),M=s===d.Run,O=s===d.Done,v=s===d.Cancelling,U=s===d.Apply,H=s===d.Applying,V=s===d.Running,f=V||H||v;function C(S){S.stopPropagation(),i()}function k(S){S.stopPropagation(),y()}function T(S){S.stopPropagation(),r()}function E(S){S.stopPropagation(),a()}function z(S){S.stopPropagation(),t()}const Y=u&&_(N);return e.jsxs("div",{className:"flex justify-between px-4 py-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(M||V)&&e.jsxs(ee,{disabled:V||n,onClick:z,autoFocus:!0,ref:B,variant:$.Primary,children:[e.jsx("span",{children:se(s,[d.Running,d.Run])}),j&&e.jsx("span",{className:"inline-block ml-1",children:"And Skip Test"}),x&&e.jsx("span",{className:"inline-block ml-1",children:"And Auto Apply"})]}),(U||H)&&e.jsx(ee,{onClick:E,disabled:H||n,ref:B,variant:$.Primary,children:se(s,[d.Applying],Y?"Apply And Backfill":g?"Apply Virtual Update":"Apply")}),f&&e.jsx(ee,{onClick:T,variant:$.Danger,className:"justify-self-end",disabled:v||n,children:se(s,[d.Cancelling],"Cancel")}),(M||V||U||H)&&e.jsxs("p",{className:"ml-2 text-xs max-w-sm",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:w.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),e.jsxs("span",{className:"inline-block mr-1",children:["from"," ",e.jsx("b",{children:_(ce(c))?c:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till ",e.jsx("b",{children:_(ce(c))?P:"today"})]}),b&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),N&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),o&&e.jsxs("span",{className:"inline-block mr-1",children:["consider as a ",e.jsx("b",{children:"Breaking Change"})]}),h&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),_(ce(R))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate folowing models ",e.jsx("b",{children:R})]})]})]}),e.jsxs("div",{className:"flex items-center",children:[[f,M,n,w.isInitial&&w.isDefault,O].every(_)&&e.jsx(ee,{onClick:k,variant:$.Neutral,disabled:oe([d.Resetting,d.Running,d.Applying,d.Cancelling],s)||n,children:se(s,[d.Resetting],"Start Over")}),e.jsx(ee,{onClick:C,variant:O?$.Primary:$.Neutral,disabled:oe([d.Running,d.Resetting,d.Cancelling],s)||n,ref:O||H?B:void 0,children:se(s,[d.Done],"Close")})]})]})}function ds({enabled:s,setEnabled:n,a11yTitle:t,className:a,disabled:r=!1}){return e.jsxs(as,{checked:r?!1:s,onChange:n,className:G("relative inline-flex h-8 w-16 shrink-0 rounded-full border-2 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-4 ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","border-secondary-30",s?"bg-secondary-500":"bg-secondary-10",a,r?"opacity-50 cursor-not-allowed":"cursor-pointer"),disabled:r,children:[e.jsx("span",{className:"sr-only",children:t}),e.jsx("span",{"aria-hidden":"true",className:G("pointer-events-none inline-block h-6 w-6 transform rounded-full shadow-md  transition duration-200 ease-in-out","bg-light translate-y-[0.125rem]",s?"translate-x-8 shadow-primary-800":"translate-x-1 shadow-neutral-300 dark:shadow-neutral-600")})]})}function Z({label:s,info:n,enabled:t,disabled:a=!1,setEnabled:r}){return e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[s,e.jsx("small",{className:"block text-xs text-neutral-500",children:n})]}),e.jsx(ds,{disabled:a,className:"mt-2",enabled:t,setEnabled:r})]})}function ps({className:s}){const n=me(),{skip_tests:t,no_gaps:a,skip_backfill:r,forward_only:i,auto_apply:y,no_auto_categorization:c,restate_models:P,isInitialPlanRun:u,create_from:j}=Q(),x=re(h=>h.environment),N=re(h=>h.environments),b=ge.getOnlySyncronized(Array.from(N));return e.jsx("li",{className:G("mt-6 mb-6",s),children:e.jsxs("form",{className:"w-full h-full",children:[e.jsxs("fieldset",{className:G("mb-10 mt-6"),children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1 px-4",children:"Set Dates"}),e.jsx("div",{className:"mt-3",children:e.jsx(F.BackfillDates,{})})]}),e.jsx("fieldset",{className:G("mb-4 mt-6"),children:e.jsx(D,{children:({open:h})=>e.jsxs(e.Fragment,{children:[e.jsxs(D.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 hover:bg-theme-darker dark:hover:bg-theme-lighter",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Additional Options"}),h?e.jsx(le,{className:"h-6 w-6 text-primary-500"}):e.jsx(ae,{className:"h-6 w-6 text-primary-500"})]}),e.jsxs(D.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:[e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[_(x.isDefault)&&e.jsxs("div",{className:"inline-block m-1 w-full",children:[e.jsx(te.Label,{children:"Create From Environment"}),e.jsx("select",{className:G("w-full bg-neutral-100 border-2 rounded-lg py-2 px-3 text-base leading-4",b.length<2&&"opacity-50 cursor-not-allowed","flex w-full text-prose-lighter bg-theme-lighter border-theme-darker dark:border-theme-lighter dark:text-prose-darker rounded-md","border-2 focus:ring-4 focus:outline-none focus:border-secondary-500","ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100"),onChange:o=>{n({type:p.PlanOptions,create_from:o.target.value})},disabled:b.length<2,value:j,children:ge.getOnlySyncronized(Array.from(N)).map(o=>e.jsx("option",{value:o.name,children:o.name},o.name))}),e.jsx(te.Info,{children:"The environment to base the plan on rather than local files"})]}),e.jsx(te,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
              downstream from the one specified. For production
              environment, all related model versions will have
              their intervals wiped, but only the current
              versions will be backfilled. For development
              environment, only the current model versions will
              be affected`,placeholder:"project.model1, project.model2",disabled:u,value:P??"",onInput:o=>{o.stopPropagation(),n({type:p.PlanOptions,restate_models:o.target.value})}})]})}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap w-full mt-3",children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(Z,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
                  are defined`,enabled:!!t,setEnabled:o=>{n({type:p.PlanOptions,skip_tests:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(Z,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
                  comparing to existing snapshots for matching
                  models in the target environment`,enabled:!!a,disabled:u,setEnabled:o=>{n({type:p.PlanOptions,no_gaps:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(Z,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!r,disabled:u,setEnabled:o=>{n({type:p.PlanOptions,skip_backfill:o})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(Z,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!i,disabled:u,setEnabled:o=>{n({type:p.PlanOptions,forward_only:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(Z,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!y,setEnabled:o=>{n({type:p.PlanOptions,auto_apply:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(Z,{label:"No Auto Categorization",info:"Set category manually",enabled:!!c,disabled:u,setEnabled:o=>{n({type:p.PlanOptions,no_auto_categorization:o})}})})]})]})]})]})})})]})})}function us({disabled:s=!1}){const n=me(),{start:t,end:a,isInitialPlanRun:r}=Q();return e.jsxs("div",{className:"flex w-full flex-wrap md:flex-nowrap",children:[e.jsx(te,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",placeholder:"2023-12-13",disabled:s||r,value:t,onInput:i=>{i.stopPropagation(),n({type:p.DateStart,start:i.target.value})}}),e.jsx(te,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",placeholder:"2022-12-13",value:a,disabled:s||r,onInput:i=>{i.stopPropagation(),n({type:p.DateEnd,end:i.target.value})}})]})}function ms({environment:s,isInitialPlanRun:n}){const{start:t,end:a,skip_tests:r,no_gaps:i,skip_backfill:y,forward_only:c,no_auto_categorization:P,restate_models:u,create_from:j}=Q(),x=m.useMemo(()=>{if(!s.isDefault)return{start:t,end:n&&ce(u)?void 0:a}},[s,t,a,n,u]);return{planOptions:m.useMemo(()=>s.isDefault||s.isInitial?{skip_tests:r}:{no_gaps:i,skip_backfill:y,forward_only:c,create_from:j,no_auto_categorization:P,skip_tests:r,restate_models:u},[s,i,y,c,j,P,r,u]),planDates:x}}function hs({isInitialPlanRun:s}){const{start:n,end:t,skip_tests:a,no_gaps:r,skip_backfill:i,forward_only:y,no_auto_categorization:c,restate_models:P,hasBackfills:u,create_from:j,change_categorization:x}=Q(),N=m.useMemo(()=>{if(!(s||_(u)))return{start:n,end:t}},[u,n,t,s]),b=m.useMemo(()=>Array.from(x.values()).reduce((h,{category:o,change:R})=>(h[R.model_name]=o.value,h),{}),[x]);return{planDates:N,planOptions:{no_gaps:r,skip_backfill:i,forward_only:y,create_from:j,no_auto_categorization:c,skip_tests:a,restate_models:P},categories:b}}function F({environment:s,isInitialPlanRun:n,initialStartDate:t,initialEndDate:a,disabled:r,onClose:i}){const y=We(),c=me(),{auto_apply:P,hasChanges:u,hasBackfills:j,hasVirtualUpdate:x,testsReportErrors:N,errors:b}=Q(),h=q(l=>l.state),o=q(l=>l.action),R=q(l=>l.activePlan),g=q(l=>l.setAction),w=q(l=>l.setState),B=m.useRef(null),[M,O]=m.useState(!1),[v]=Ke(),U=ms({environment:s,isInitialPlanRun:n}),H=hs({isInitialPlanRun:n}),{refetch:V}=He(s.name,U),{refetch:f}=Le(s.name,H),C=m.useCallback(Ge(V,1e3,!0),[V]);m.useEffect(()=>{const l=v("tests",k);return s.isInitial&&s.isDefault&&xe(),c([{type:p.Dates,start:t,end:a}]),()=>{C.cancel(),l==null||l()}},[]),m.useEffect(()=>{c([{type:p.External,isInitialPlanRun:n}]),n&&c([{type:p.PlanOptions,skip_backfill:!1,forward_only:!1,no_auto_categorization:!1,no_gaps:!1}])},[n]),m.useEffect(()=>{_(M)&&s.isInitial||oe([A.Running,A.Applying,A.Cancelling],h)||(_(M)?g(d.Run):_(u||j)&&_(x)||oe([A.Finished,A.Failed],h)?g(d.Done):g(d.Apply))},[h,M,u,j,x]),m.useEffect(()=>{R!=null&&c({type:p.BackfillProgress,activeBackfill:R})},[R]);function k(l){c([Qe(l.ok)?{type:p.TestsReportMessages,testsReportMessages:l}:{type:p.TestsReportErrors,testsReportErrors:l}])}function T(){O(!1),c([{type:p.ResetBackfills},{type:p.ResetChanges},{type:p.Dates,start:t,end:a},{type:p.ResetPlanOptions}])}function E(){g(d.Resetting),T(),w(A.Init),g(d.Run)}function z(){i()}function Y(){c([{type:p.ResetErrors},{type:p.ResetTestsReport}]),w(A.Cancelling),g(d.Cancelling),Ye(y).then(()=>{g(d.Run),w(A.Cancelled)}).catch(l=>{pe(l)?console.log("apiCancelPlanApply","Request aborted by React Query"):(console.log("apiCancelPlanApply",l),c([{type:p.Errors,errors:[l.message]}]),E())})}function S(){c([{type:p.ResetErrors},{type:p.ResetTestsReport}]),g(d.Applying),w(A.Applying),f({throwOnError:!0}).then(({data:l})=>{(l==null?void 0:l.type)===Ze.Virtual&&w(A.Finished)}).catch(l=>{pe(l)?console.log("planApply","Request aborted by React Query"):(console.log("planApply",l),c([{type:p.Errors,errors:[l.message]}]),E())}).finally(()=>{var l;(l=B==null?void 0:B.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})})}function xe(){c([{type:p.ResetErrors},{type:p.ResetTestsReport}]),g(d.Running),w(A.Running),C({throwOnError:!0}).then(({data:l})=>{c([{type:p.Backfills,backfills:l==null?void 0:l.backfills},{type:p.Changes,...l==null?void 0:l.changes},{type:p.Dates,start:l==null?void 0:l.start,end:l==null?void 0:l.end}]),O(!0),w(A.Init),P?S():g(d.Run)}).catch(l=>{pe(l)?console.log("planRun","Request aborted by React Query"):(console.log("planRun",l),c([{type:p.Errors,errors:[l.message]}]),E())})}const we=X(N)||I(b);return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden pt-6",children:[we?e.jsxs(qe,{sizes:X(N)?[50,50]:[30,70],direction:"vertical",snapOffset:0,className:"flex flex-col w-full h-full overflow-hidden",children:[e.jsx(F.Header,{}),e.jsx(F.Wizard,{setRefTasksOverview:B})]}):e.jsxs(e.Fragment,{children:[e.jsx(F.Header,{}),e.jsx(ye,{}),e.jsx(F.Wizard,{setRefTasksOverview:B})]}),e.jsx(ye,{}),e.jsx(F.Actions,{disabled:r,planAction:o,apply:S,run:xe,cancel:Y,close:z,reset:E})]})}F.Actions=os;F.Header=is;F.Wizard=ts;F.StepOptions=ps;F.BackfillDates=us;export{F as default};
